<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dragon Ball · Archivo Vivo Blindado</title>

<style>
:root{
 --bg: #05050b;
 --grid: rgba(74, 158, 255, 0.05);
 --gold: #ffd166;
 --red: #ff4757;
 --blue: #2ed573;
 --neon: #7cf6ff;
 --ink: #f1f2f6;
 --card-bg: #1e272e;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
 margin: 0;
 font-family: 'Segoe UI', system-ui, sans-serif;
 color: var(--ink);
 background-color: var(--bg);
 background-image: 
  linear-gradient(var(--grid) 1px, transparent 1px),
  linear-gradient(90deg, var(--grid) 1px, transparent 1px);
 background-size: 40px 40px;
 min-height: 100vh;
 padding-bottom: 80px; /* Espacio para el cronista */
 overflow-x: hidden;
}

/* --- HEADER --- */
header { padding: 2rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
.title {
 font-size: clamp(2rem, 8vw, 3.5rem);
 font-weight: 900;
 letter-spacing: -2px;
 line-height: 1;
 color: var(--gold);
 text-shadow: 4px 4px 0 var(--red);
 margin-bottom: 0.5rem;
}
.subtitle {
 font-size: 0.9rem;
 letter-spacing: 2px;
 text-transform: uppercase;
 opacity: 0.7;
 color: var(--neon);
}

/* --- CONTROLES --- */
.controls { padding: 1.5rem; display: flex; gap: 10px; flex-wrap: wrap; }
.search-input, .filter-select {
 padding: 12px;
 background: rgba(0,0,0,0.3);
 border: 1px solid #333;
 border-radius: 8px;
 color: #fff;
 font-size: 1rem;
}
.search-input { flex: 2; min-width: 200px; }
.filter-select { flex: 1; min-width: 100px; }
.search-input:focus, .filter-select:focus { border-color: var(--gold); }

/* --- SECCIONES --- */
.section { padding: 0 1.5rem 2rem 1.5rem; }
.section-title {
 font-size: 0.8rem;
 letter-spacing: 3px;
 color: var(--gold);
 margin-bottom: 1rem;
 opacity: 0.8;
 text-transform: uppercase;
 border-left: 3px solid var(--red);
 padding-left: 10px;
}

/* --- SCROLL HORIZONTAL (PERSONAJES/SAGAS) --- */
.scroll-track {
 display: flex;
 gap: 15px;
 overflow-x: auto;
 padding-bottom: 10px;
 scroll-behavior: smooth;
 scrollbar-width: none; /* Firefox */
}
.scroll-track::-webkit-scrollbar { display: none; }

/* PERSONAJE AVATAR */
.char-btn {
 flex: 0 0 auto;
 width: 80px;
 height: 80px;
 border-radius: 50%;
 border: 2px solid #333;
 cursor: pointer;
 transition: transform 0.2s, border-color 0.2s;
 overflow: hidden;
 background: #000;
 position: relative;
}
.char-btn.active {
 border-color: var(--gold);
 transform: scale(1.1);
 box-shadow: 0 0 15px rgba(255, 209, 102, 0.4);
}
.char-btn img { width: 100%; height: 100%; object-fit: cover; }

/* TARJETA FALLBACK (Cuando falla la imagen) */
.fallback-card {
 width: 100%; height: 100%;
 display: flex; align-items: center; justify-content: center;
 background: linear-gradient(135deg, #333, #111);
 color: #777; font-size: 0.7rem; text-align: center;
 font-weight: bold; padding: 5px;
}

/* --- GALERÍA --- */
.gallery-grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
 gap: 15px;
}
.media-item {
 aspect-ratio: 16/9;
 border-radius: 10px;
 overflow: hidden;
 background: #111;
 cursor: pointer;
 border: 1px solid transparent;
 transition: all 0.2s;
 position: relative;
}
.media-item:hover { border-color: var(--neon); transform: translateY(-3px); }
.media-item img, .media-item video {
 width: 100%; height: 100%; object-fit: cover;
 display: block;
}

/* --- ÁRBOL DE DATOS --- */
.tree-container {
 border-left: 2px dashed #333;
 padding-left: 15px;
}
.tree-node {
 padding: 8px 0;
 cursor: pointer;
 color: #888;
 transition: 0.3s;
 font-family: monospace;
 font-size: 1.1rem;
}
.tree-node:hover { color: var(--ink); }
.tree-node.active { color: var(--gold); text-shadow: 0 0 10px rgba(255,209,102,0.3); }
.tree-detail {
 font-size: 0.9rem;
 color: var(--neon);
 margin-left: 1rem;
 display: none;
 padding: 5px 0 15px 0;
}
.tree-node.active + .tree-detail { display: block; animation: slideDown 0.3s ease; }

@keyframes slideDown { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }

/* --- CRONISTA (PIE DE PÁGINA) --- */
#chronicle {
 position: fixed;
 bottom: 0; left: 0; right: 0;
 background: rgba(5, 5, 11, 0.95);
 border-top: 2px solid var(--gold);
 padding: 1rem;
 color: var(--gold);
 font-family: monospace;
 text-align: center;
 transform: translateY(100%);
 transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
 z-index: 100;
}
#chronicle.visible { transform: translateY(0); }

/* --- EFECTO GLITCH GLOBAL --- */
.glitch-active { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake {
 10%, 90% { transform: translate3d(-1px, 0, 0); }
 20%, 80% { transform: translate3d(2px, 0, 0); }
 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
 40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* Ocultar elementos filtrados */
.hidden { display: none !important; }

</style>
</head>
<body>

<header>
 <div class="title">DBZ<span style="color:var(--neon)">.ARC</span></div>
 <div class="subtitle">Sistema de Archivo Multiverso v3.0</div>
</header>

<div class="controls">
 <input type="text" id="searchInput" class="search-input" placeholder="Buscar registros...">
 <select id="filterSelect" class="filter-select">
  <option value="ALL">Todo</option>
  <option value="DBZ">Z</option>
  <option value="SUPER">Súper</option>
  <option value="GT">GT</option>
 </select>
</div>

<div class="section">
 <div class="section-title">Entidades Detectadas</div>
 <div id="charContainer" class="scroll-track">
  </div>
</div>

<div class="section">
 <div class="section-title">Estructura Lógica</div>
 <div id="treeContainer" class="tree-container">
  </div>
</div>

<div class="section">
 <div class="section-title">Evidencia Visual</div>
 <div id="galleryContainer" class="gallery-grid">
  </div>
</div>

<div id="chronicle">Iniciando sistema...</div>

<audio id="sfxGlitch" preload="auto">
 <source src="https://assets.mixkit.co/sfx/preview/mixkit-tv-static-1003.mp3" type="audio/mp3">
</audio>

<script>
/**
 * BASE DE DATOS BLINDADA
 * Si las URLs fallan, el sistema usará fallbacks automáticos.
 */
const DB = [
 {
  id: "goku_ui",
  name: "Goku UI",
  universe: "SUPER",
  desc: "El estado de los dioses. Movimiento instintivo.",
  avatar: "https://static.wikia.nocookie.net/dragonball/images/8/8a/Goku_UI.png", 
  media: [
   { type: "img", src: "https://pm1.aminoapps.com/6688/d7168865668d2b270a4a62241d70a3c20058b877_00.jpg" },
   { type: "video", src: "https://cdn.coverr.co/videos/coverr-energy-burst-1534/1080p.mp4" }
  ]
 },
 {
  id: "vegeta_maj",
  name: "Majin Vegeta",
  universe: "DBZ",
  desc: "Orgullo corrupto. Sacrificio final.",
  avatar: "https://static.wikia.nocookie.net/dragonball/images/a/a2/Majin_Vegeta_render.png",
  media: [
   { type: "img", src: "https://i.pinimg.com/originals/9f/8e/33/9f8e33467614d9d1502472d825313988.gif" }
  ]
 },
 {
  id: "goku_ssj4",
  name: "Goku SSJ4",
  universe: "GT",
  desc: "Poder primigenio recuperado.",
  avatar: "https://static.wikia.nocookie.net/dragonball/images/6/6a/Goku_GT_SSJ4.png",
  media: [
   { type: "img", src: "https://media.giphy.com/media/3o6ZtpxSZbQRRnwCKQ/giphy.gif" },
   { type: "img", src: "https://pa1.narvii.com/6204/85050f2832049e083c26053075249a5bf3143878_hq.gif" }
  ]
 },
 {
  id: "freezer",
  name: "Freezer",
  universe: "DBZ",
  desc: "El emperador del mal.",
  avatar: "https://static.wikia.nocookie.net/dragonball/images/3/36/Frieza_Final_Form_Render.png",
  media: [
   { type: "img", src: "https://media.giphy.com/media/11mMb7iI651fMs/giphy.gif" }
  ]
 }
];

// --- REFERENCIAS DOM ---
const refs = {
 chars: document.getElementById('charContainer'),
 tree: document.getElementById('treeContainer'),
 gallery: document.getElementById('galleryContainer'),
 chronicle: document.getElementById('chronicle'),
 search: document.getElementById('searchInput'),
 filter: document.getElementById('filterSelect'),
 audio: document.getElementById('sfxGlitch')
};

// --- ESTADO ---
let currentSelection = null;

// --- FUNCIONES CORE ---

function init() {
 renderCharacters();
 renderTree();
 
 // Activar el primero por defecto para que no se vea vacío
 activate(DB[0].id);

 // Event Listeners
 refs.search.addEventListener('input', applyFilters);
 refs.filter.addEventListener('change', applyFilters);
}

function activate(id) {
 const entity = DB.find(e => e.id === id);
 if (!entity) return;

 currentSelection = id;

 // 1. Feedback Visual en Personajes
 document.querySelectorAll('.char-btn').forEach(btn => {
  btn.classList.toggle('active', btn.dataset.id === id);
 });

 // 2. Feedback Visual en Árbol
 renderTree(); // Re-render para actualizar estados active

 // 3. Cargar Galería (Con protección)
 loadGallery(entity);

 // 4. Mostrar Mensaje
 speak(entity.desc);

 // 5. Efecto Glitch (Seguro)
 triggerGlitch();
}

function loadGallery(entity) {
 refs.gallery.innerHTML = '';
 
 if(!entity.media || entity.media.length === 0) {
  refs.gallery.innerHTML = '<div style="color:#555; padding:20px;">Sin registros visuales.</div>';
  return;
 }

 entity.media.forEach(m => {
  const card = document.createElement('div');
  card.className = 'media-item';
  card.onclick = () => speak("Visualizando archivo: " + entity.name);

  let content;
  
  if (m.type === 'video') {
   content = document.createElement('video');
   content.src = m.src;
   content.muted = true;
   content.loop = true;
   content.playsInline = true; // Importante para móviles
   // Intento de auto-play seguro con observer
   observer.observe(content);
  } else {
   content = document.createElement('img');
   content.src = m.src;
  }

  // SISTEMA DE FALLBACK (Anti-Rotura)
  content.onerror = () => {
   card.innerHTML = `<div class="fallback-card">ARCHIVO CORRUPTO<br>${entity.name}</div>`;
   card.style.border = "1px solid var(--red)";
  };

  card.appendChild(content);
  refs.gallery.appendChild(card);
 });
}

function renderCharacters() {
 refs.chars.innerHTML = '';
 DB.forEach(ent => {
  const btn = document.createElement('div');
  btn.className = 'char-btn';
  btn.dataset.id = ent.id;
  btn.dataset.uni = ent.universe;
  btn.dataset.name = ent.name.toLowerCase();
  btn.onclick = () => activate(ent.id);

  const img = document.createElement('img');
  img.src = ent.avatar;
  // Fallback para avatar
  img.onerror = () => {
   img.style.display = 'none';
   btn.innerHTML = `<div class="fallback-card" style="font-size:0.6rem">${ent.universe}<br>${ent.name}</div>`;
  };

  btn.appendChild(img);
  refs.chars.appendChild(btn);
 });
}

function renderTree() {
 refs.tree.innerHTML = '';
 DB.forEach(ent => {
  const isActive = currentSelection === ent.id;
  
  const node = document.createElement('div');
  node.className = 'tree-item-wrapper'; // Wrapper para filtrar
  node.dataset.uni = ent.universe;
  node.dataset.name = ent.name.toLowerCase();

  const title = document.createElement('div');
  title.className = `tree-node ${isActive ? 'active' : ''}`;
  title.textContent = `> [${ent.universe}] ${ent.name}`;
  title.onclick = () => activate(ent.id);

  const detail = document.createElement('div');
  detail.className = 'tree-detail';
  detail.textContent = ent.desc;

  node.appendChild(title);
  node.appendChild(detail);
  refs.tree.appendChild(node);
 });
 applyFilters(); // Re-aplicar filtros si los hay
}

// --- UTILIDADES DE INTERFAZ ---

function speak(text) {
 refs.chronicle.textContent = ">>> " + text;
 refs.chronicle.classList.add('visible');
 
 // Resetear timer anterior si existe
 if(window.speakTimer) clearTimeout(window.speakTimer);
 window.speakTimer = setTimeout(() => {
  refs.chronicle.classList.remove('visible');
 }, 3000);
}

function triggerGlitch() {
 document.body.classList.add('glitch-active');
 playSoundSafe();
 setTimeout(() => document.body.classList.remove('glitch-active'), 250);
}

function playSoundSafe() {
 // Intenta reproducir, si falla (por permisos), no hace nada.
 // Esto evita el error rojo en consola.
 const playPromise = refs.audio.play();
 if (playPromise !== undefined) {
  playPromise.catch(error => {
   // Auto-play bloqueado. No hacemos nada, es normal.
  });
 }
 refs.audio.currentTime = 0;
}

function applyFilters() {
 const term = refs.search.value.toLowerCase();
 const uni = refs.filter.value;

 const filterFn = (el) => {
  const name = el.dataset.name;
  const u = el.dataset.uni;
  const matchTerm = !term || name.includes(term);
  const matchUni = uni === 'ALL' || u === uni;
  
  if(matchTerm && matchUni) el.classList.remove('hidden');
  else el.classList.add('hidden');
 };

 document.querySelectorAll('.char-btn').forEach(filterFn);
 document.querySelectorAll('.tree-item-wrapper').forEach(filterFn);
}

// --- OBSERVER PARA VIDEOS (Eficiencia) ---
const observer = new IntersectionObserver((entries) => {
 entries.forEach(entry => {
  if (entry.isIntersecting) {
   entry.target.play().catch(()=>{}); // Catch play error
  } else {
   entry.target.pause();
  }
 });
}, { threshold: 0.5 });

// --- ARRANQUE ---
// Pequeño delay para asegurar carga de DOM
setTimeout(init, 100);

</script>
</body>
</html>
